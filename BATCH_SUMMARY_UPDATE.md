# 分批总结功能更新说明

## 更新内容

针对视频内容总结部分的优化，实现了分批处理功能来解决长视频导致的token限制问题。

## 主要改进

### 1. 智能分批策略
- **阈值设置**: 当分析的帧数超过30帧时，自动启用分批处理
- **批次大小**: 每30帧为一批进行分析和总结
- **动态处理**: 根据视频长度自动决定是否需要分批处理

### 2. 分批处理流程
```
原始流程: 所有帧描述 → 一次性总结
新流程: 所有帧描述 → 分批总结 → 最终合并总结
```

具体步骤：
1. **逐帧分析**: 继续使用原有的逐帧图像分析方式
2. **判断分批**: 根据帧数决定处理方式
   - ≤30帧: 直接生成总结 (原有流程)
   - >30帧: 启用分批处理
3. **分批总结**: 每30帧生成一个段落总结
4. **最终合并**: 将所有段落总结合并为完整的视频总结

### 3. Token优化
- **批次总结**: 每批使用500 tokens，生成80-120字的段落总结
- **最终总结**: 使用1000 tokens，生成150-250字的完整总结
- **直接总结**: 使用800 tokens，生成100-150字的总结（≤30帧时）

## 新增的方法

### AIVisionAnalyzer.h
- `void processBatch(int batchIndex, int batchSize)` - 处理单个批次
- `void generateFinalMergedSummary()` - 生成最终合并总结
- `void generateDirectSummary(const QStringList &descriptions)` - 直接总结（少量帧时）
- `void onBatchSummaryReply()` - 处理批次总结响应

### 新增成员变量
- `QStringList batchSummaries` - 存储各批次总结
- `int currentBatchIndex` - 当前处理的批次索引
- `int totalBatches` - 总批次数

## 优势

### 1. 解决Token限制问题
- 避免长视频描述超出模型输入限制
- 分批处理减少单次请求的数据量

### 2. 提高处理效率
- 每个批次并行处理（避免API限制）
- 分阶段生成，提高成功率

### 3. 保持总结质量
- 段落总结保持时序关系
- 最终合并确保内容连贯性
- 智能提示词优化

### 4. 向后兼容
- 短视频继续使用原有直接总结方式
- 长视频自动启用分批处理
- 用户无需额外配置

## 使用场景

### 适合分批处理的场景
- 长时间录制的教程视频 (>30帧)
- 复杂操作流程的演示
- 多步骤的软件操作记录

### 继续使用直接总结的场景
- 短时间的操作记录 (≤30帧)
- 简单的界面展示
- 快速操作演示

## 调试信息

更新后的代码增加了详细的调试日志：
- 批次处理进度跟踪
- 分批总结状态监控
- 最终合并过程记录
- 错误处理和恢复机制

## 配置说明

无需额外配置，系统会自动根据帧数选择处理方式：
- 帧数 ≤ 30: 自动使用直接总结
- 帧数 > 30: 自动使用分批处理 + 最终合并

批次大小固定为30帧，可以根据需要在代码中调整 `BATCH_SIZE` 常量。
